<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Order - Amar Bazar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #2ecc71; --cashback: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; margin: 0; padding: 15px; }
        .container { max-width: 450px; margin: auto; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .product-header { position: relative; text-align: center; padding: 20px; }
        .product-header img { width: 100%; max-height: 200px; object-fit: contain; }
        .cashback-badge { position: absolute; top: 10px; left: 0; background: var(--cashback); color: white; padding: 5px 12px; font-size: 12px; font-weight: bold; border-radius: 0 20px 20px 0; }
        .details { padding: 20px; }
        .edit-section { background: #f1f1f1; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .qty-input { width: 60px; text-align: center; padding: 5px; font-weight: bold; }
        .order-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; font-size: 18px; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 20px; }
        
        /* Processing Timer Overlay */
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        .timer-text { font-size: 40px; font-weight: bold; color: var(--primary); margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container" id="mainApp">
    <div class="product-header">
        <div class="cashback-badge">CASHBACK ৳<span id="cbVal">5</span></div>
        <img src="https://cdn-icons-png.flaticon.com/512/869/869432.png" alt="Milk">
    </div>

    <div class="details">
        <div style="font-size: 24px; font-weight: bold;">৳<span id="currentPrice">80</span></div>
        <h2>Pure Fresh Milk</h2>
        
        <div class="edit-section">
            <p>আপনার ইউজার আইডি (Mobile):</p>
            <input type="tel" id="userId" placeholder="017XXXXXXXX" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            
            <p>পরিমাণ (লিটার):</p>
            <input type="number" id="qty" class="qty-input" value="1" min="1" oninput="updateTotal()">
        </div>

        <div style="margin-top: 15px; font-weight: bold; color: #e74c3c;">
            Total Bill: ৳<span id="totalMinus">80</span>
        </div>

        <button class="order-btn" onclick="processOrder()">Confirm Order</button>
    </div>
</div>

<div id="overlay">
    <div class="timer-text" id="timeLeft">10</div>
    <h2>অর্ডার প্রসেসিং হচ্ছে...</h2>
    <p>অপেক্ষা করুন, ব্যালেন্স চেক করা হচ্ছে।</p>
</div>

<script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyDvSODDF6mMbMq4uAin9nn8r8RWSn6xA7c",
        authDomain: "amar-bazar-77e5d.firebaseapp.com",
        databaseURL: "https://amar-bazar-77e5d-default-rtdb.firebaseio.com",
        projectId: "amar-bazar-77e5d",
        storageBucket: "amar-bazar-77e5d.firebasestorage.app",
        messagingSenderId: "1005911914259",
        appId: "1:1005911914259:web:f6c6f999499f0f757f0ce6"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const unitPrice = 80;

    function updateTotal() {
        let q = document.getElementById('qty').value;
        let total = q * unitPrice;
        document.getElementById('totalMinus').innerText = total;
        document.getElementById('currentPrice').innerText = total;
        document.getElementById('cbVal').innerText = q * 5;
    }

    function processOrder() {
        const id = document.getElementById('userId').value;
        const q = document.getElementById('qty').value;
        const bill = q * unitPrice;

        if(!id) { alert("ইউজার আইডি দিন!"); return; }

        let confirmOrder = confirm("৳" + bill + " কেটে নেওয়া হবে। আপনি কি নিশ্চিত?");
        if(confirmOrder) {
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('overlay').style.display = 'flex';

            // Firebase থেকে ব্যালেন্স চেক ও আপডেট
            const userRef = database.ref('users/' + id);
            userRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    let currentBalance = snapshot.val().balance;
                    if (currentBalance >= bill) {
                        // টাকা কেটে নেওয়া
                        let newBalance = currentBalance - bill;
                        userRef.update({ balance: newBalance });

                        // অ্যাডমিনকে অর্ডার জানানো (অর্ডার লিস্টে ডাটা সেভ করা)
                        database.ref('orders/').push({
                            userId: id,
                            quantity: q,
                            totalBill: bill,
                            status: "Pending",
                            time: new Date().toLocaleString()
                        });

                        startTimer();
                    } else {
                        alert("আপনার ব্যালেন্স পর্যাপ্ত নয়!");
                        location.reload();
                    }
                } else {
                    alert("ইউজার আইডি পাওয়া যায়নি!");
                    location.reload();
                }
            });
        }
    }

    function startTimer() {
        let seconds = 10;
        let countdown = setInterval(function() {
            seconds--;
            document.getElementById('timeLeft').innerText = seconds;
            if (seconds <= 0) {
                clearInterval(countdown);
                alert("অর্ডার সফল হয়েছে! ১০ মিনিটের মধ্যে অ্যাডমিন কনফার্ম করবে।");
                window.location.href = "https://amarbazar-dev.github.io/My-app/"; // হোম লিঙ্কে ফিরত
            }
        }, 1000);
    }
</script>

</body>
</html>
